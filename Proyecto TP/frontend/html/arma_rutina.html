<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet"href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css">
         <!-- CSS -->
        <link rel="stylesheet" href="../css/style.css">
        <title>Arma rutina</title>
    </head>
    <body>
        <div class="envoltorio-pagina">
            <!-- HEADER -->
            <header class="header" id="header">
            <!-- Sección de navegación -->
                <a href="index.html" class="txt-atlas" aria-label="Texto de la marca de la página llamada Atlas+">Atlas+</a>
                <nav class="container-contenido-header" aria-label="Navegación principal">
                    <ul class="nav_list" id="nav-list">
                        <li class="nav-link">
                             <a class="txt-home" href="index.html">Inicio</a>
                        </li>
                        <li class="nav-link">
                            <a class="txt-home" href="quienes_somos.html">Quienes Somos</a>
                        </li>
                        <li>
                            <a class="nav-rutinas-btn" href="rutinas_alimentacion.html">Armá tu rutina</a>
                        </li>
                    </ul>
                </nav>
            </header>
            <main>
                <section class="section-table">
                    <div class="entrenamiento-title">
                        <div>
                            <h1>Organiza tus entrenamientos</h1>
                        </div>
                        <div>
                            <button class="button" id="btn-abrir-modal">Agregar</button>
                        </div>
                    </div>
                    <table class="table">
                    <thead>
                        <tr>
                            <th>Dia de la Semana </th>
                            <th>Objetivo</th>
                            <th>Nivel Usuario</th>
                            <th>Duracion (minutos)</th>
                            <th>Descripcion</th>
                            <th>Editar</th>
                            <th>Borrar</th>
                        </tr>
                    </thead>
                    <tbody class="body-table"></tbody>
                </table>
                </section>
            </main>
            <!--- MODAL PARA AGREGAR ENTRENAMIENTO -->
            <div class="modal" id="modal-agregar">
                <div class="modal-background"></div>
                <div class="modal-card">
                    <header class="modal-card-head">
                        <p class="modal-card-title">Agregar entrenamiento</p>
                        <button class="delete" aria-label="close" id="cerrar-modal"></button>
                    </header>
                    <section class="modal-card-body">
                        <form id="form-entrenamiento">
                            <div class="field">
                                <label class="label"> Dia de la semana</label>
                                <div class="control">
                                    <input class="input" type="text" name="dia_semana" required>
                                </div>
                            </div>

                            <div class="field">
                                <label class="label"> Objetivo</label>
                                <div class="control">
                                    <input class="input" type="text" name="objetivo" required>
                                </div>
                            </div>

                            <div class="field">
                                <label class="label"> Nivel Usuario</label>
                                <div class="control">
                                    <input class="input" type="text" name="nivel_usuario" required>
                                </div>
                            </div>

                            <div class="field">
                                <label class="label"> Duracion (minutos)</label>
                                <div class="control">
                                    <input class="input" type="number" name="duracion_minutos" required>
                                </div>
                            </div>

                            <div class="field">
                                <label class="label"> Descripcion</label>
                                <div class="control">
                                    <textarea class="textarea" name="descripcion"></textarea>
                                </div>
                            </div>
                        </form>
                    </section>
                    <footer class="modal-card-foot">
                        <button class="button is-success" id="btn-guardar">Guardar</button>
                        <button class="button" id="btn-cancelar">Cancelar</button>
                    </footer>
                </div>
            </div>
            <footer class="footer-seccion">
                <div class="footer-container">
                    <h2 class="copyrightTeam" alt="Copyright 404 not found">404 not found</h2>
                    <div class="equipo-facultad">
                        <ul>Rodrigo Riera</ul>
                        <ul>Tomas Diaz</ul>
                        <ul>Tiago Nehuen Sedano</ul>
                        <ul>Lucas Ferreira</ul>
                    </div>
                </div>
            </footer>
        </div>
    <script>
        tablaEntrenos();

        //mostrar modal
        document.querySelector('#btn-abrir-modal').addEventListener('click', () => {
            document.getElementById('modal-agregar').classList.add('is-active');
        });
        //ocultar modal
        function cerrarModal(){
            document.getElementById('modal-agregar').classList.remove('is-active');
            document.getElementById('form-entrenamiento').reset();
        }
        document.getElementById('cerrar-modal').addEventListener('click', cerrarModal);
        document.getElementById('btn-cancelar').addEventListener('click', cerrarModal);
        document.querySelector('#modal-agregar .modal-background').addEventListener('click', cerrarModal);
        //enviar nuevo entrenamiento
        document.getElementById('btn-guardar').addEventListener('click', async () => {
            const form = document.getElementById('form-entrenamiento');
            
            const dia = form.dia_semana.value.trim(); // Eliminamos espacios en blanco
            const objetivo = form.objetivo.value.trim();

            // Validaciones
            if (dia === "") {
                alert("El campo 'Día de la semana' es obligatorio.");
                return; // No continúa si está vacío
            } else if (objetivo === "") {
                alert("El campo 'Objetivo' es obligatorio.");
                return; 
            }

            const datos = {
                dia_semana: dia,
                objetivo: objetivo,
                nivel_usuario: form.nivel_usuario.value,
                duracion_minutos: parseInt(form.duracion_minutos.value),
                descripcion: form.descripcion.value
            };

            try {
                const respuesta = await fetch("http://localhost:3000/api/entrenamientos", {
                    method: "POST",
                    headers: {"Content-type": "application/json"},
                    body: JSON.stringify(datos)
                });

                if(respuesta.ok) {
                    cerrarModal();
                    tablaEntrenos();
                    alert("Entrenamiento agregado correctamente");
                } else {
                    alert("Error al agregar el entrenamiento");
                }
            } catch(error) {
                console.error("Error al enviar", error);
            }
        });

        function tablaEntrenos(){
            document.getElementsByClassName("body-table")[0].innerHTML = ""; // limpia la tabla antes de cargarla

            const arma_rutinaBackURL = "http://localhost:3000/api/entrenamientos";

            fetch(arma_rutinaBackURL).then((response) => { // se va a consultar al back
                return response.json();
            }).then((data) => { // una vez que consulta vuelve con la data
                const table = document.querySelector("tbody");
                const entrenamientosRecientes = data.reverse();

                entrenamientosRecientes.forEach(Entrenamiento => {
                    const newRow = document.createElement("tr");

                    const DiaSemana = document.createElement("td"); // Dia de la Semana
                    DiaSemana.innerHTML = Entrenamiento.dia_semana;
                    newRow.appendChild(DiaSemana);

                    const Objetivo = document.createElement("td"); // Objetivo
                    Objetivo.innerHTML = Entrenamiento.objetivo;
                    newRow.appendChild(Objetivo);

                    const NivelUsuario = document.createElement("td"); // Nivel Usuario
                    NivelUsuario.innerHTML = Entrenamiento.nivel_usuario && Entrenamiento.nivel_usuario.trim() !== "" ? Entrenamiento.nivel_usuario : "-"; 
                    newRow.appendChild(NivelUsuario);

                    const Duracion = document.createElement("td"); // Duracion
                    Duracion.innerHTML = Entrenamiento.duracion_minutos ?? "-";
                    newRow.appendChild(Duracion);

                    const Descripcion = document.createElement("td"); // Descripcion
                    Descripcion.innerHTML = Entrenamiento.descripcion && Entrenamiento.descripcion.trim() !== ""
                        ? (Entrenamiento.descripcion.length > 40 
                            ? Entrenamiento.descripcion.slice(0, 40) + "..." 
                            : Entrenamiento.descripcion)
                        : "-"; // si son mas de 40 caracteres, corta y agrega "..."
                    newRow.appendChild(Descripcion);

                    const NewEditar = document.createElement("td"); // Editar
                    const EditarLink = document.createElement("a");
                    EditarLink.className = "button";
                    EditarLink.innerHTML = "Editar";
                    EditarLink.href = "ejercicios.html?id=" + Entrenamiento.id; // id= querry param
                    NewEditar.appendChild(EditarLink);
                    newRow.appendChild(NewEditar);
            
                    const NewBorrar = document.createElement("td"); // Borrar
                    const BorrarLink = document.createElement("a");
                    BorrarLink.className = "button";
                    BorrarLink.innerHTML = "Borrar";
                    BorrarLink.onclick = function(){
                        if(confirm("Estas seguro de que deseas eliminar este entrenamiento?")){
                            deleteEntrenamiento(Entrenamiento.id);
                            alert("Entrenamiento eliminado correctamente");
                        } 
                    };
                    NewBorrar.appendChild(BorrarLink);
                    newRow.appendChild(NewBorrar);

                    table.appendChild(newRow);
                });
            });
        }

        function deleteEntrenamiento(id){
            const arma_rutinaBackURL = "http://localhost:3000/api/entrenamientos/" + id;
            fetch(arma_rutinaBackURL, {method: 'DELETE'}).then(() => tablaEntrenos()); // vuelve a cargar la tabla
        }
    </script>
    </body>
</html>
